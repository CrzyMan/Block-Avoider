<!DOCTYPE HTML>

<html>
    <head>
        <title>Block Avoider</title>
        <style>
            canvas{
                border: dashed;
                background-color: white;
                float: left;
            }
            
            div.right{
                float:right;
                font-size: 30pt;
            }
        </style>
        <script src="vectors.js"></script>
        <script src="arrays+.js"></script>
        <script src="pauseableTimeEvents.js"></script>
        <script src="objects+.js"></script>
        <script src="simpleDatabase.js"></script>
        
    </head>

    <body style="background-color: lightgray">
        <canvas id='canvas' width="500" height="500">
            This Browser does not support the Canvas element. Please use a different Browser.
        </canvas>
        
        <div  style="float: left; font-size: 30pt">
            <div id="TimeNSuch"></div>
            <br/><br/>
            <div id="d_gameStatus"></div>
        </div>
        
        
        <div style="float: right">
            <h1 style="font-size: 40pt"><u>Avoid The Blocks</u></h1>
            <d style="font-size: 20pt">
                Click the 'Start' button and then move<br/> your mouse into the box.<br/><br/>
                Press 'p' to toggle pause ON and OFF.<br/>
            </d><br/>
            <button id="b_start" style="font-size: 20pt" onclick="startGame();">Start</button><br/><br/>
            End Explosion Velocity Style<br/>
            <select id="s_endStyles">
                <option value="norm">Normalized</option>
                <option value="normDist">Normalized Modified By Distance</option>
            </select><br/>
            <button id="b_TrON" onclick="toggleTrails();" disabled="disabled">Turn Explosion Trails On</button>
            <button id="b_TrOFF" onclick="toggleTrails();">Turn Explosion Trails Off</button>
            <br/><br/>
            <br/>
            
            Leaders<br/>
            <select id="s_leaders">
                <option value="false">No Leaders Yet</option>
            </select>
            
        </div>
        
        <script type="text/javascript">
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var canvasRect = {x: 0, y:0, width: canvas.width, height: canvas.height};
            
            var TimeNSuch = document.getElementById('TimeNSuch');
            var Time = 0;
            var Multiplier = 0;
            var Score = 0;
            setTimeNSuch();
            
            var s_endStyles = document.getElementById('s_endStyles');
            
            var s_leaders = document.getElementById('s_leaders');
            
            var Playing = false;
            
            var frameRate = 64;
            
            var TrailsInExplode = true;
            var b_TrON = document.getElementById('b_TrON');
            var b_TrOFF = document.getElementById('b_TrOFF');
            
            var d_gameStatus = document.getElementById('d_gameStatus');
            
            // elements: {name, score, time}
            var GameData = new SimpleDatabase();
            
            var EndStyles = {
                norm: function(){
                    var mMid = new Vector2d(mouseBox.x + 2, mouseBox.y + 2);
                    for (var i = Blocks.length-1; i>=0; i--){
                        var b = Blocks[i];
                        var bMid = new Vector2d(b.pos.x + b.width/2, b.pos.y + b.height/2);
                        var norm = new Vector2d(bMid.x - mMid.x, bMid.y - mMid.y).norm();
                        b.vel = new Vector2d(norm.x * 3, norm.y * 3);
                        b.drawMe();
                    }
                },
                
                normDist: function(){
                    var mMid = new Vector2d(mouseBox.x + 2, mouseBox.y + 2);
                    // measure distance from corner to center, add distance from mouse to center to get max distance posible
                    var mD = (new Vector2d(0,-25).distanceFrom(new Vector2d(canvas.width/2, canvas.height/2))) +
                            mMid.distanceFrom(new Vector2d(canvas.height/2, canvas.width/2));
                    
                    for (var i = Blocks.length-1; i>=0; i--){
                        var b = Blocks[i];
                        var bMid = new Vector2d(b.pos.x + b.width/2, b.pos.y + b.height/2);
                        var norm = new Vector2d(bMid.x - mMid.x, bMid.y - mMid.y).norm();
                        var dist = mMid.distanceFrom(bMid);
                        b.vel = new Vector2d(norm.x * 3 * (1-(dist/mD)), norm.y * 3 * (1-(dist/mD)));
                        b.drawMe();
                    }
                }
            };
            
            var Blocks = [];
            function Block(){
                
                // initialize position and velocity
                this.pos = new Vector2d();
                this.vel = new Vector2d();
                
                // set height and width of the block
                this.width = 15 + Math.floor(Math.random() * 35);
                this.height = 15 + Math.floor(Math.random() * 35);
                
                /* */
                this.pos.x = -5 + Math.floor(Math.random() * (canvas.width - this.width + 20));
                this.pos.y = -this.height;
                
                this.vel.y = 2 + Math.floor(Math.random() * 6)
                /* */
                
                
                this.vel.x = this.vel.x * (32/frameRate);
                this.vel.y = this.vel.y * (32/frameRate);
                
                this.color = {r: Math.floor(Math.random() * 255), g: Math.floor(Math.random() * 255), b: Math.floor(Math.random() * 255)};
                
                this.drawMe = function(){
                    ctx.save();
                    ctx.fillStyle = "rgb("+this.color.r+","+this.color.g+","+this.color.b+")";
                    ctx.fillRect(this.pos.x, this.pos.y, this.width, this.height);
                    ctx.fillStyle = "black";
                    ctx.strokeRect(this.pos.x, this.pos.y, this.width, this.height);
                    ctx.restore();
                }
                
                this.update = function(){
                    this.pos._add(this.vel);
                    
                    if (!this.intersectsWith(canvasRect)){
                        this.kill();
                    }
                    
                    this.drawMe();
                }
                
                this.kill = function(){
                    Blocks.splice(Blocks.indexOf(this),1);
                }
                
                Blocks.push(this);
            }
            
            //var i_tick = window.setInterval(tick, 1000/frameRate);
            var i_tick = new PauseableInterval(tick, 1000/frameRate);
            i_tick.pause();
            
            //var i_newBox = window.setInterval("new Block()", 100)
            var i_newBox = new PauseableInterval("new Block()", 100);
            i_newBox.pause();
            
            var mouseBox = {
                x: 0,
                y: 0,
                height: 4,
                width: 4,
                drawMe: function(){
                    ctx.fillRect(this.x, this.y, 4, 4);
                }
            };
            
            var i_addTimeAndScore = new PauseableInterval(addTimeAndScore, 1000);
            i_addTimeAndScore.pause();
            
            function tick(){
                ctx.clearRect(0,0,canvas.width, canvas.height);
                
                // set Background for Multiplier key
                drawMultiplierKey();
                
                if (mouseBox.y < canvas.height/4) Multiplier=3;
                else if (mouseBox.y >= canvas.height/2) Multiplier=1;
                else Multiplier=2;
                
                setTimeNSuch();
                
                for (var i = Blocks.length-1; i>=0; i--){
                    Blocks[i].update();
                    if (Blocks[i].intersectsWith(mouseBox)){
                        endGame(i);
                        return;
                    }
                }
                
                mouseBox.drawMe();
                
                // offscreen
                if (!mouseBox.intersectsWith(canvasRect)){
                    TogglePause();
                }
                
            }
            
            document.onkeypress = function(e){
                if (!Playing) return;
                var code = e.keyCode || e.which;
                switch (code){
                    case 112:
                        TogglePause();
                        break;
                }
            }
            
            function TogglePause(){
                // toggle Pause
                if (i_tick.i != null){
                    i_tick.pause();
                    i_newBox.pause();
                    i_addTimeAndScore.pause();
                    
                    d_gameStatus.innerText = "Game Paused";
                }
                else{
                    i_tick.resume();
                    i_newBox.resume();
                    i_addTimeAndScore.resume();
                    
                    d_gameStatus.innerText = "";
                }
            }
            
            document.onmousemove = function(e){
                mouseBox.x = e.x - 12 - 2;
                mouseBox.y = e.y - 12 - 2;
            }
            
            var CountDownNumber = 3;
            var CountDownOpacity = 1;
            function startGame(){
                document.getElementById('b_start').disabled = true;
                fadeNumber();
            }
            
            function fadeNumber(){
                ctx.clearRect(0,0,canvas.height, canvas.width);
                
                if (CountDownNumber>=0 && CountDownOpacity>=.01){
                    CountDownOpacity -= 1/100;
                    setTimeout(fadeNumber, 10);
                } else if (CountDownNumber >= 0){
                    CountDownNumber--;
                    CountDownOpacity = 1;
                    setTimeout(fadeNumber, 10);
                } else {
                    i_tick.resume();
                    i_newBox.resume();
                    i_addTimeAndScore.resume();
                    Playing = true;
                    return;
                }
                
                ctx.save();
                ctx.fillStyle = "rgba(0,0,0,"+CountDownOpacity+")";
                ctx.font = "40pt calibri";
                if (CountDownNumber>0) ctx.fillText(CountDownNumber, canvas.width/2 - 20, canvas.height/2);
                else ctx.fillText("GO!", canvas.width/2 - 50, canvas.height/2);
                
                ctx.restore();
            }
            
            var i_end;
            
            function endGame(index){
                
                // pick end style
                EndStyles[s_endStyles.value]();
                
                mouseBox.drawMe();
                
                i_tick.pause();
                i_newBox.pause();
                i_addTimeAndScore.pause();
                
                Playing = false;
                
                i_end = new PauseableInterval(explode, 1000/frameRate);
                i_end.resume();
                
            }
            
            function explode(){
                if (!TrailsInExplode){
                    ctx.clearRect(0,0,canvas.width, canvas.height);
                    drawMultiplierKey();
                }
                
                for (var i = Blocks.length-1; i>=0; i--){
                    Blocks[i].update();
                }
                if (Blocks.length == 0){
                    i_end.pause();
                    i_end = null;
                    i_end = new PauseableInterval(fadeOut, 10);
                    endFadeEnded = false;
                    setTimeout("endFadeEnded = true;",500);
                }
            }
            
            var endFadeEnded = false;
            function fadeOut(){
                ctx.save();
                ctx.fillStyle= "rgba(255,255,255,0.1)";
                ctx.fillRect(0,0,canvas.width, canvas.height);
                ctx.restore();
                
                if(endFadeEnded){
                    i_end.pause();
                    i_end = null;
                    ctx.clearRect(0,0,canvas.width, canvas.height);
                    document.getElementById('b_start').disabled = false;
                    
                    CountDownNumber = 3;
                    CountDownOpacity = 1;
                    endFadeEnded = false;
                    
                    ctx.save();
                    ctx.font = "40pt Calibri";
                    ctx.fillStyle = "black";
                    ctx.fillText("Score: "+Score,0,40);
                    ctx.restore();
                    
                    getNameAndAddToData();
                    
                    Score = 0;
                    Time = 0;
                    Multiplier = 0;
                    setTimeNSuch();
                }
            }
            
            function setTimeNSuch(){
                var str = "Time: " + Time + "<br/>Multiplier: " + Multiplier + "<br/>Score: " + Score;
                TimeNSuch.innerHTML = str;
            }
            
            function addTimeAndScore(){
                Time++;
                Score += Multiplier;
            }
            
            function toggleTrails(){
                if (TrailsInExplode) TrailsInExplode=false;
                else TrailsInExplode=true;
                
                b_TrON.disabled = TrailsInExplode;
                b_TrOFF.disabled = !TrailsInExplode;
            }
            
            function drawMultiplierKey(){
                // set Background for Multiplier key
                ctx.save();
                ctx.fillStyle = "rgba(0,255,0,.5)";
                ctx.fillRect(0,0,canvas.width, canvas.height/4);
                ctx.fillStyle = "rgba(255,255,0,.5)";
                ctx.fillRect(0,canvas.height/4, canvas.width, canvas.height/4);
                ctx.fillStyle = "rgba(255,0,0,.5)";
                ctx.fillRect(0, canvas.height/2, canvas.width, canvas.height);
                ctx.restore();
            }
            
            function getNameAndAddToData(){
                
                var p = prompt("What is you name?")
                
                var player = GameData.getElementByProperty("name", p);
                
                if (player){
                    if (player.score > Score){
                        var v = confirm("Your score this game is lower than what is in the database.\nWould you like to overwrite your last score?")
                        if (v){
                            player.score = Score;
                            player.time = Time;
                        }
                    } else {
                        player.score = Score;
                        player.time = Time;
                    }
                } else {
                    GameData.add({name: p, score: Score, time: Time})
                }
                
                orderAndDisplayGameData();
            }
            
            function orderAndDisplayGameData(){
                GameData.orderBy("time", true);
                GameData.orderBy("score", true);
                s_leaders.innerHTML = "";
                for (var i = 0; i < GameData.db.length; i++){
                    s_leaders.innerHTML += "<option>Name: "+GameData.db[i].name+" | Score: "+GameData.db[i].score+" | Time: "+GameData.db[i].time;
                }
            }
            
            
            /*****************************
             *    START TESTING AREA     *
             *****************************/
            
            
            
            /*****************************
             *     END TESTING AREA      *
             *****************************/
            
        </script>
    </body>
</html>
